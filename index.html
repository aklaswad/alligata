<html>
<head>
<style>
#drawer, #sim-drawer, #grid, #points {
  position: fixed;
  top: 30px;
  background: rgba(0,0,0,0.0);
  border: 1px solid #888;
  width: 1000px;
  height: 600px;
}

#grid {
  z-index: 10000;
}

.point.target {
  border: 2px solid #f84;
}

.point.set {
  border: 2px solid #888;
}

.point.linear {
  border: 2px solid #0f0;
}

.point.exponential {
  border: 2px solid #00f;
}
</style>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="wa-envelope-editor.js"></script>
<script>
$(function () {


  var points = [];


  var xToTime = function(x) {
    return parseFloat(x);
  };

  var yToVal = function(y) {
    return parseFloat(y);
  };

  var printCode = function (points) {
    var lines = [
      'var fn = function (ctx,param) {',
      '  var now = ctx.currentTime;'
    ];

    var lastTime = 0.0;
    for ( var i=0; i<points.length;i++ ) {
      var p = points[i];
      switch (p.type) {
        case 'set':
          lines.push( '  param.setValueAtTime(' + yToVal(p.y).toString() + ', now + ' + xToTime(p.x) + ');' );
          break;
        case 'linear':
          lines.push( '  param.linearRampToValueAtTime(' + yToVal(p.y).toString() + ', now + ' + xToTime(p.x) + ');' );
          break;
        case 'exponential':
          lines.push( '  param.exponentialRampToValueAtTime(' + yToVal(p.y).toString() + ', now + ' + xToTime(p.x) + ');' );
          break;
        case 'target':
          lines.push( '  param.setTargetAtTime(' + yToVal(p.y).toString() + ', now + ' + xToTime(p.x).toString() + ', ' + xToTime(p.c) + ');' );

      }
      lastTime = xToTime(p.x);
    }
    lines.push( '};' );
    return lines.join('\n');
  };



  var points = [];

  var code = printCode(points);
  var fn = eval(code + 'fn');

  var canvas = $('#drawer').get(0);
  var ctx = canvas.getContext('2d');
  ctx.strokeStyle = 'rgba(255,0,0,0.4)';
  ctx.lineWidth = 1;

  var canvas2 = $('#sim-drawer').get(0);
  var ctx2 = canvas2.getContext('2d');
  ctx2.strokeStyle = 'rgba(0,255,0,0.4)';
  var sim = new EnvelopeSimDrawer(ctx2);

  var canvas3 = $('#grid').get(0);
  var ctx3 = canvas3.getContext('2d');
  ctx3.strokeStyle = 'rgba(128,128,128,0.3)';
  ctx3.fillStyle = 'rgba(128,128,128,1)';
  var grid = new GridDrawer(ctx3);

  var AudioContext = window.AudioContext || webkitAudioContext || mozAudioContext;
  var actx = new AudioContext();
  var drawer = new EnvelopeDrawer(ctx,actx,10);

  var width = 1000;
  var height = 600;
  var zoomX = 128;
  var zoomY = 64;
  var offsetX = 0;
  var offsetY = 0;
  function redraw () {
    ctx.clearRect(0,0,width,height);
    ctx2.clearRect(0,0,width,height);
    ctx3.clearRect(0,0,width,height);
    drawer.zoomX = sim.zoomX = grid.zoomX = zoomX;
    drawer.zoomY = sim.zoomY = grid.zoomY = zoomY;
    drawer.offsetX = sim.offsetX = grid.offsetX = offsetX;
    drawer.offsetY = sim.offsetY = grid.offsetY = offsetY;
    if ( !dragging ) {
      code = printCode(points);
      fn = eval(code + ';fn');
      drawer.draw(fn);
    }
    sim.draw(points);
    grid.draw();
    refreshPoints();
  }

  var last = 0;
  $('#grid').on('mousemove', function (e) {
    if ( pdragging ) return true;
    $('#stat').text(
      'x: ' + e.offsetX
    + ' y: ' + e.offsetY
    + ' ' + ( e.offsetX * zoomX / 44100 - offsetX) + 's '
    + ((height - e.offsetY) / zoomY - offsetY)
    );
  });

  function screenX2X (x) {
    return x * zoomX / 44100 - offsetX;
  }

  function screenY2Y (y) {
    return (height - y) / zoomY - offsetY;
  }

  function x2ScreenX (x) {
    return (x + offsetX) * 44100 / zoomX;
  }

  function y2ScreenY (y) {
    return height - (y + offsetY) * zoomY;
  }


  var dragging = false;
  var dragBegin;
  $('#grid').on('mousedown', function (e) {
    dragBegin = [e.offsetX,e.offsetY, offsetX, offsetY];
    dragging = true;
    return false;
  });

  $('#grid').on('mousemove', function (e) {
    if ( dragging ) {
      offsetX = dragBegin[2] - (dragBegin[0] - e.offsetX) * zoomX / 44100;
      offsetY = dragBegin[3] + (dragBegin[1] - e.offsetY) / zoomY;
      redraw();
      return false;
    }
  });

  $('#grid').on('mouseup', function (e) {
    dragging = false;
    redraw();
    return false;
  });

  $('#grid').on('mousewheel', function (e) {
    if ( !e.originalEvent.deltaX && !e.originalEvent.deltaY ) return false;
    var now = (new Date()).getTime();
    if ( now < last + 300 ) return false;
    last = now;
    var sx = e.offsetX;
    var sy = e.offsetY;
    var xx = screenX2X(sx);
    var yy = screenY2Y(sy);

    zoomX *= e.originalEvent.deltaX > 0 ? 2 : e.originalEvent.deltaX < 0 ? 0.5 : 1;
    zoomY *= e.originalEvent.deltaY > 0 ? 0.5 : e.originalEvent.deltaY < 0 ? 2 : 1;

    if ( zoomX < 1 ) zoomX = 1;
    offsetX = -screenX2X(x2ScreenX(xx) - sx);
    offsetY = -screenY2Y(height + (y2ScreenY(yy) -  sy));
    redraw();
    $('#stat').text(
      'x: ' + e.offsetX
    + ' y: ' + e.offsetY
    + ' ' + ( e.offsetX * zoomX / 44100 - offsetX) + 's '
    + ((height - e.offsetY) / zoomY - offsetY)
    );
    return false;
  });

  $('.zoom').click( function () {
    if ( $(this).attr('data-axis') === 'x' ) {
      if ( $(this).attr('data-op') === '+' ) {
        zoomX /= 2;
      }
      else {
        zoomX *= 2;
      }
      if ( zoomX < 1 ) zoomX = 1;
    }
    else {
      if ( $(this).attr('data-op') === '+' ) {
        zoomY *= 2;
      }
      else {
        zoomY /= 2;
      }
    }
    redraw();
  });

  $('.offset').click( function () {
    if ( $(this).attr('data-axis') === 'x' ) {
      if ( $(this).attr('data-op') === '+' ) {
        offsetX += width * 0.1 * zoomX / 44100;
      }
      else {
        offsetX -= width * 0.1 * zoomX / 44100;
      }
    }
    else {
      if ( $(this).attr('data-op') === '+' ) {
        offsetY += height * 0.1 / zoomY;
      }
      else {
        offsetY -= height * 0.1 / zoomY;
      }
    }
    redraw();
  });



// test
  var startPoints = [
    { type: 'set', x: 0, y: -3 },

    { type: 'set', x: 0.2, y: -2, c: 1 },
    { type: 'set', x: 0.4, y: 3, c: 1 },
    { type: 'set', x: 0.6, y: -2.3, c: 1 },
    { type: 'target', x: 0.8, y: 4, c:.3 },
    { type: 'target', x: 1, y: -2.1,c:.2 },
    { type: 'set', x: 1.2, y: 4, c:1 },
    { type: 'target', x: 2, y: 0, c:1 },
    { type: 'linear', x: 3, y: 5, c:1 },
    { type: 'exponential', x: 4, y: 2, c:1},
    { type: 'linear', x: 5, y: 3, c:1 },
    { type: 'target', x: 6, y: -2, c:1 }
  ];


  var typeLoop = {
    linear: 'exponential',
    exponential: 'set',
    set: 'target',
    target: 'linear'
  };
  $(document).on('click', '.point', function () {
    if ( $(this).attr('data-dragging') ) {
      $(this).removeAttr('data-dragging');
      return;
    }
    var newType = typeLoop[$(this).attr('data-type')];
    $(this).removeClass('set target exponential linear');
    $(this).attr('data-type', newType);
    $(this).addClass(newType);
    rebuildPoints();
  });


  var pdragging = false;
  var pdragBegin;
  $(document).on('mousedown', '.point', function (e) {
    pdragging = $(this);
    return false;
  });

  $('#points').on('mousemove', function (e) {
    if ( pdragging && $(e.target).is('#grid') ) {
      pdragging
        .css({
          top: e.offsetY,
          left: e.offsetX,
        })
        .attr('data-x', screenX2X(e.offsetX))
        .attr('data-y', screenY2Y(e.offsetY))
        .attr('data-dragging', 1)
      rebuildPoints();
      return false;
    }
  });

  $('#points').on('mouseup', function (e) {
    if ( pdragging ) {
      pdragging = false;
      refreshPoints();
      return false;

    }
  });


  function refreshPoints() {
    $('.point').each( function () {
      $(this).css({
        left: x2ScreenX( parseFloat($(this).attr('data-x')) ) - 5,
        top: y2ScreenY( parseFloat($(this).attr('data-y')) ) - 5
      });
    });
  }

  for ( var i=0;i<startPoints.length;i++) {
    var p = startPoints[i];
    var x = x2ScreenX(p.x);
    var y = y2ScreenY(p.y);
    var div = $('<div />')
      .css({
        position: 'absolute',
        width: '5px',
        height: '5px',
        'z-Index': 99999999
      })
      .addClass('point')
      .addClass(p.type)
      .attr('data-type', p.type)
      .attr('data-x', p.x)
      .attr('data-y', p.y)
      .attr('data-c', p.c)
      .appendTo( $('#points') );
  }
  rebuildPoints();
  redraw();
  function rebuildPoints () {
    points = [];
    $('.point').each( function () {
      var obj = {};
      obj.x = parseFloat($(this).attr('data-x'));
      obj.y = parseFloat($(this).attr('data-y'));
      obj.c = parseFloat($(this).attr('data-c'));
      obj.type = $(this).attr('data-type');
      points.push(obj);
    });
    points.sort( function (a,b){ return a.x - b.x });
    code = printCode(points);
    fn = eval(code + 'fn');
    redraw();
  };
});
</script>
</head>
<body>

<div id="points" width="1000" height="600" />
<canvas id="drawer" width="1000" height="600"></canvas>
<canvas id="sim-drawer" width="1000" height="600"></canvas>
<canvas id="grid" width="1000" height="600"></canvas>

<button class="zoom" data-axis="x" data-op="+">X+</button>
<button class="zoom" data-axis="x" data-op="-">X-</button>
<button class="zoom" data-axis="y" data-op="+">Y+</button>
<button class="zoom" data-axis="y" data-op="-">Y-</button>
<button class="offset" data-axis="x" data-op="+">X+</button>
<button class="offset" data-axis="x" data-op="-">X-</button>
<button class="offset" data-axis="y" data-op="+">Y+</button>
<button class="offset" data-axis="y" data-op="-">Y-</button>
<span id="stat"></span>
</body>

</html>
